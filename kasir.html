<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MONITOR PRO - GOOGLE VOICE & INPUT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes kedip-border { 
            0% { border-color: #ef4444; box-shadow: 0 0 5px #ef4444; } 
            50% { border-color: #eab308; box-shadow: 0 0 20px #eab308; } 
            100% { border-color: #ef4444; box-shadow: 0 0 5px #ef4444; } 
        }
        .pesanan-baru { animation: kedip-border 1.5s infinite; border-width: 3px; transform: scale(1.01); z-index: 10; }
        body { background-color: #0f172a; scroll-behavior: smooth; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-white min-h-screen font-sans overflow-x-hidden">

    <script>
        if (sessionStorage.getItem('role') !== 'kasir_valid') {
            window.location.href = 'login.html';
        }
    </script>

    <div id="overlay-start" class="fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center cursor-pointer text-center" onclick="mulaiAplikasi()">
        <div class="bg-blue-600 w-28 h-28 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-2xl shadow-blue-500/40">
            <i class="fa-solid fa-play text-4xl ml-2"></i>
        </div>
        <h1 class="text-3xl font-black tracking-tighter mb-2 uppercase">Aktifkan Sistem</h1>
        <p class="text-slate-500 text-xs uppercase tracking-[0.3em]">Klik untuk Suara & Sinkronisasi</p>
    </div>

    <nav class="bg-slate-900/80 border-b border-slate-800 p-4 sticky top-0 z-40 glass shadow-2xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-600 rounded-2xl shadow-lg">
                    <i class="fa-solid fa-cash-register text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black leading-none tracking-tight">KASIR <span class="text-blue-500">MONITOR</span></h1>
                    <div id="status-koneksi" class="flex items-center gap-2 text-[10px] text-slate-500 font-bold mt-1 uppercase tracking-widest">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="modalTambahPesanan()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-xl text-xs font-black shadow-lg transition border border-green-400/20 uppercase flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> Pesan Langsung
                </button>
                <button onclick="tutupToko()" class="px-5 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-xs font-black transition uppercase">
                    Tutup Buku
                </button>
            </div>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 gap-6 mb-10">
            <div onclick="gantiFilter('pending')" id="tab-pending" class="bg-slate-800 p-8 rounded-[2.5rem] border-2 border-yellow-500 cursor-pointer shadow-2xl relative transition-all active:scale-95">
                <h3 class="text-slate-500 font-black uppercase text-xs tracking-widest mb-2">Antrean Masuk</h3>
                <p id="count-pending" class="text-6xl font-black italic">0</p>
                <div class="absolute top-6 right-8 text-yellow-500/20"><i class="fa-solid fa-receipt text-6xl"></i></div>
            </div>
            <div onclick="gantiFilter('lunas')" id="tab-lunas" class="bg-slate-800 p-8 rounded-[2.5rem] border-2 border-transparent cursor-pointer shadow-2xl relative transition-all active:scale-95 opacity-60">
                <h3 class="text-slate-500 font-black uppercase text-xs tracking-widest mb-2">Selesai</h3>
                <p id="count-lunas" class="text-6xl font-black italic">0</p>
                <div class="absolute top-6 right-8 text-green-500/20"><i class="fa-solid fa-check-circle text-6xl"></i></div>
            </div>
        </div>

        <h2 id="judul-list" class="text-2xl font-black mb-8 flex items-center gap-3 tracking-tighter text-yellow-500">
            <i class="fa-solid fa-bolt"></i> DAFTAR ANTRIAN DAPUR
        </h2>

        <div id="grid-pesanan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full py-20 text-center text-slate-600 border-2 border-dashed border-slate-800 rounded-[3rem]">
                <p class="italic">Memuat data...</p>
            </div>
        </div>
    </div>

    <script>
        const SUP_URL = 'https://wythxpljidldaqmrplua.supabase.co';
        const SUP_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb';
        const client = supabase.createClient(SUP_URL, SUP_KEY);

        let bell = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        let dataPesanan = [];
        let filterStatus = 'pending';
        let audioOk = false;

        function bicara(teks) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(teks);
            msg.lang = 'id-ID';
            msg.rate = 0.95; 
            window.speechSynthesis.speak(msg);
        }

        function mulaiAplikasi() {
            document.getElementById('overlay-start').style.display = 'none';
            if (!audioOk) { bell.play().then(() => bell.pause()); audioOk = true; }
            ambilData();
            bicara("Sistem siap.");
        }

        async function ambilData() {
            const { data, error } = await client.from('pesanan').select('*').eq('di_arsip', false).order('created_at', { ascending: false });
            if (!error) {
                dataPesanan = data || [];
                renderLayar();
            }
        }

        function renderLayar() {
            const pending = dataPesanan.filter(x => x.status_bayar === 'pending');
            const lunas = dataPesanan.filter(x => x.status_bayar !== 'pending');
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-lunas').innerText = lunas.length;

            const list = filterStatus === 'pending' ? pending : lunas;
            const container = document.getElementById('grid-pesanan');

            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-slate-700 font-bold uppercase tracking-widest border-2 border-dashed border-slate-800 rounded-[3rem]">Belum Ada Data</div>`;
                return;
            }

            container.innerHTML = list.map(o => {
                const isBaru = o.status_bayar === 'pending' ? 'pesanan-baru' : '';
                const jam = new Date(o.created_at).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                const rupiah = parseInt(o.total_bayar).toLocaleString('id-ID');

                return `
                <div class="bg-slate-800 rounded-[2.5rem] overflow-hidden border border-slate-700 shadow-2xl flex flex-col transition-all duration-300 ${isBaru}">
                    <div class="p-6 border-b border-slate-700 flex justify-between items-start">
                        <div>
                            <span class="text-[9px] font-black text-slate-500 block uppercase tracking-widest mb-1">${o.metode_bayar.toUpperCase()}</span>
                            <h3 class="text-4xl font-black tracking-tighter">MEJA ${o.no_meja}</h3>
                            <p class="text-sm font-bold text-blue-400 mt-1 uppercase">${o.nama_konsumen}</p>
                        </div>
                        <span class="text-[10px] font-mono text-slate-600 bg-slate-950 px-3 py-1 rounded-full">${jam}</span>
                    </div>
                    <div class="p-7 flex-grow">
                        <div class="bg-slate-900/50 p-5 rounded-3xl border border-slate-700/50 shadow-inner">
                            <pre class="whitespace-pre-wrap font-mono text-sm text-slate-300 leading-relaxed">${o.catatan}</pre>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-900/50 border-t border-slate-700 flex flex-col gap-3">
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total</span>
                            <span class="text-2xl font-black text-white">Rp ${rupiah}</span>
                        </div>
                        ${o.status_bayar === 'pending' && o.metode_bayar === 'qr' ? 
                            `<button onclick="lihatBukti('${o.bukti_url}')" class="w-full bg-amber-500 hover:bg-amber-400 text-white font-black py-3 rounded-2xl transition shadow-lg text-[10px] uppercase tracking-widest">
                                <i class="fa-solid fa-camera mr-2"></i> Cek Bukti TF
                            </button>` : ''
                        }
                        <div class="flex gap-3">
                        ${o.status_bayar === 'pending' ? 
                            `<button onclick="konfirmasiLunas(${o.id}, ${o.total_bayar})" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition shadow-lg text-xs uppercase tracking-widest">Konfirmasi</button>` : 
                            `<button onclick="printLagi('${o.no_meja}', '${o.nama_konsumen}', '${o.catatan.replace(/\n/g, '\\n')}', ${o.total_bayar}, '${o.created_at}')" class="flex-1 bg-slate-700 hover:bg-white hover:text-black text-white font-black py-4 rounded-2xl transition text-xs uppercase flex items-center justify-center gap-2 border border-slate-600"><i class="fa-solid fa-print"></i> Print</button>`
                        }
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function modalTambahPesanan() {
            const { value: formValues } = await Swal.fire({
                title: 'INPUT PESANAN KASIR',
                background: '#1e293b',
                color: '#fff',
                html: `
                    <div class="flex flex-col gap-3 text-left">
                        <label class="text-xs font-bold text-slate-400 uppercase">Nomor Meja</label>
                        <input id="sw-meja" class="p-3 rounded-xl bg-slate-700 border-none text-white w-full" type="number">
                        <label class="text-xs font-bold text-slate-400 uppercase">Nama Pelanggan</label>
                        <input id="sw-nama" class="p-3 rounded-xl bg-slate-700 border-none text-white w-full">
                        <label class="text-xs font-bold text-slate-400 uppercase">Daftar Pesanan</label>
                        <textarea id="sw-catatan" class="p-3 rounded-xl bg-slate-700 border-none text-white w-full h-24" placeholder="Contoh: 2 Kopi, 1 Nasi Goreng"></textarea>
                        <label class="text-xs font-bold text-slate-400 uppercase">Total Harga</label>
                        <input id="sw-total" class="p-3 rounded-xl bg-slate-700 border-none text-white w-full" type="number">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'SIMPAN & LUNASKAN',
                confirmButtonColor: '#10B981',
                preConfirm: () => {
                    return {
                        meja: document.getElementById('sw-meja').value,
                        nama: document.getElementById('sw-nama').value,
                        catatan: document.getElementById('sw-catatan').value,
                        total: document.getElementById('sw-total').value
                    }
                }
            });

            if (formValues) {
                if (!formValues.meja || !formValues.total) return Swal.fire('Error', 'Meja & Total wajib diisi!', 'error');
                const { error } = await client.from('pesanan').insert([{
                    no_meja: formValues.meja,
                    nama_konsumen: formValues.nama || 'Pelanggan Kasir',
                    catatan: formValues.catatan,
                    total_bayar: formValues.total,
                    metode_bayar: 'tunai',
                    status_bayar: 'lunas',
                    di_arsip: false
                }]);
                if (!error) {
                    Swal.fire('Sukses', 'Pesanan disimpan ke riwayat.', 'success');
                    ambilData();
                }
            }
        }

        client.channel('monitor-pro').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pesanan' }, (payload) => {
            bell.play().catch(e => {});
            bicara(`Pesanan baru. Meja ${payload.new.no_meja}.`);
            ambilData();
        }).subscribe();

        function lihatBukti(url) {
            Swal.fire({ title: 'Bukti Pembayaran', imageUrl: url, background: '#1e293b', color: '#fff' });
        }

        async function konfirmasiLunas(id, total) {
            const r = await Swal.fire({ 
                title: 'Konfirmasi Lunas?', text: `Total Rp ${total.toLocaleString()}`, 
                icon: 'question', showCancelButton: true, confirmButtonColor: '#10B981', background: '#1e293b', color: '#fff' 
            });
            if (r.isConfirmed) { 
                await client.from('pesanan').update({ status_bayar: 'lunas' }).eq('id', id); 
                ambilData(); 
            }
        }

        async function tutupToko() {
            const r = await Swal.fire({
                title: 'Arsipkan Semua?', text: 'Semua antrean hari ini akan dipindahkan ke laporan owner.',
                icon: 'warning', showCancelButton: true, confirmButtonText: 'YA, TUTUP BUKU', background: '#1e293b', color: '#fff'
            });
            if (r.isConfirmed) {
                await client.from('pesanan').update({ di_arsip: true }).eq('di_arsip', false);
                ambilData();
                Swal.fire('Selesai', 'Shift ditutup.', 'success');
            }
        }

        function gantiFilter(s) {
            filterStatus = s;
            document.getElementById('judul-list').innerText = s === 'pending' ? 'DAFTAR ANTRIAN DAPUR' : 'RIWAYAT SELESAI HARI INI';
            document.getElementById('tab-pending').className = s === 'pending' ? 'bg-slate-800 p-8 rounded-[2.5rem] border-2 border-yellow-500 cursor-pointer shadow-2xl relative transition-all active:scale-95' : 'bg-slate-800 p-8 rounded-[2.5rem] border-2 border-transparent cursor-pointer shadow-2xl relative transition-all active:scale-95 opacity-60';
            document.getElementById('tab-lunas').className = s === 'lunas' ? 'bg-slate-800 p-8 rounded-[2.5rem] border-2 border-green-500 cursor-pointer shadow-2xl relative transition-all active:scale-95' : 'bg-slate-800 p-8 rounded-[2.5rem] border-2 border-transparent cursor-pointer shadow-2xl relative transition-all active:scale-95 opacity-60';
            renderLayar();
        }

        function printLagi(meja, nama, items, total, tgl) {
            const d = new Date(tgl).toLocaleString('id-ID');
            let s = `\x1b\x40\x1b\x61\x01\x1b\x21\x30CAFE KAMI\n\x1b\x21\x00STRUK PEMBAYARAN\n--------------------------------\n\x1b\x61\x00MEJA : ${meja}\nNAMA : ${nama}\n--------------------------------\n${items}\n--------------------------------\n\x1b\x61\x02TOTAL: Rp ${parseInt(total).toLocaleString()}\n\n\n\n\x1d\x56\x00`;
            window.location.href = "rawbt:data=" + encodeURIComponent(s);
        }
    </script>
</body>
</html>
