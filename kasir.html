<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MONITOR (SECURE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes kedip { 0% { border-color: red; } 50% { border-color: yellow; } 100% { border-color: red; } }
        .pesanan-baru { animation: kedip 1.5s infinite; border-width: 2px; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <script>
        // Cek apakah punya tiket masuk sebagai 'kasir_valid'
        if (sessionStorage.getItem('role') !== 'kasir_valid') {
            alert("ANDA BELUM LOGIN! SILAKAN LOGIN DULU.");
            window.location.href = 'login.html'; // TENDANG KELUAR
        }
    </script>

    <div id="overlay-start" class="fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center cursor-pointer" onclick="mulaiAplikasi()">
        <div class="text-6xl mb-4 animate-bounce">üëÜ</div>
        <h1 class="text-3xl font-bold text-green-400">KLIK UNTUK MULAI</h1>
    </div>

    <nav class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2"><span class="text-2xl">üñ•Ô∏è</span><h1 class="font-bold">KASIR AREA</h1></div>
        <div class="flex gap-2">
            <button onclick="logout()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs">LOGOUT</button>
            <button onclick="tutupToko()" class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-xs font-bold">TUTUP TOKO</button>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 gap-6 mb-8">
            <div onclick="gantiFilter('pending')" class="bg-gray-800 p-6 rounded-2xl border border-gray-700 cursor-pointer hover:border-yellow-500">
                <h3 class="text-gray-400 text-xs font-bold uppercase">Pesanan Masuk</h3>
                <p id="count-pending" class="text-5xl font-black">0</p>
            </div>
            <div onclick="gantiFilter('lunas')" class="bg-gray-800 p-6 rounded-2xl border border-gray-700 cursor-pointer hover:border-green-500">
                <h3 class="text-gray-400 text-xs font-bold uppercase">Selesai</h3>
                <p id="count-lunas" class="text-5xl font-black">0</p>
            </div>
        </div>
        <h2 id="judul-list" class="text-2xl font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-2">ANTRIAN</h2>
        <div id="grid-pesanan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wythxpljidldaqmrplua.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let audioNotif = new Audio('notif.wav'); let dataPesanan = []; let filterStatus = 'pending';

        function logout() {
            sessionStorage.removeItem('role');
            window.location.href = 'login.html';
        }

        function mulaiAplikasi() {
            document.getElementById('overlay-start').style.display = 'none';
            audioNotif.play().then(()=>{audioNotif.pause(); audioNotif.currentTime=0}).catch(e=>{});
            ambilData();
        }

        async function ambilData() {
            const { data, error } = await client.from('pesanan').select('*').eq('di_arsip', false).order('created_at', { ascending: false });
            if(!error) { dataPesanan = data || []; renderLayar(); }
        }

        function renderLayar() {
            const pending = dataPesanan.filter(x => x.status_bayar === 'pending');
            const lunas = dataPesanan.filter(x => x.status_bayar !== 'pending');
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-lunas').innerText = lunas.length;
            const listTampil = filterStatus === 'pending' ? pending : lunas;
            const container = document.getElementById('grid-pesanan');

            if (listTampil.length === 0) { container.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500">Tidak ada data.</div>`; return; }

            container.innerHTML = listTampil.map(o => {
                const badge = o.metode_bayar==='qr' ? '<span class="bg-blue-900 text-blue-200 px-2 py-1 text-xs rounded">QRIS</span>' : '<span class="bg-orange-900 text-orange-200 px-2 py-1 text-xs rounded">TUNAI</span>';
                const safeCatatan = (o.catatan||'').replace(/\n/g,'\\n').replace(/'/g,"\\'");
                
                return `
                <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700 ${o.status_bayar==='pending'?'pesanan-baru':''}">
                    <div class="p-4 bg-gray-700/50 flex justify-between items-start">
                        <div><h3 class="text-2xl font-bold">Meja ${o.no_meja}</h3><p class="text-sm text-gray-300">üë§ ${o.nama_konsumen||'-'}</p></div>
                        <div class="text-right"><span class="text-xs text-gray-400 block mb-1">${new Date(o.created_at).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</span>${badge}</div>
                    </div>
                    <div class="p-4 bg-gray-800/50 border-t border-b border-gray-700"><pre class="whitespace-pre-wrap font-mono text-sm text-gray-300">${o.catatan}</pre></div>
                    <div class="p-4 bg-gray-900 flex justify-between items-center">
                        <div><p class="text-xs text-gray-500">Total</p><p class="text-xl font-bold">Rp ${parseInt(o.total_bayar).toLocaleString('id-ID')}</p></div>
                        ${o.status_bayar==='pending' ? 
                        `<div class="flex gap-2">
                            <button onclick="hapus(${o.id})" class="bg-red-900 text-red-200 px-3 py-2 rounded">üóëÔ∏è</button>
                            <button onclick="cek(${o.id},'${o.nama_konsumen}',${o.total_bayar},'${o.metode_bayar}','${o.bukti_url}')" class="bg-blue-600 px-4 py-2 rounded font-bold">${o.metode_bayar==='qr'?'CEK BUKTI':'TERIMA'}</button>
                        </div>` : 
                        `<button onclick="print('${o.no_meja}','${o.nama_konsumen}','${safeCatatan}',${o.total_bayar},'${o.created_at}')" class="bg-gray-700 px-4 py-2 rounded border border-gray-600">üñ®Ô∏è PRINT</button>`}
                    </div>
                </div>`;
            }).join('');
        }

        async function hapus(id) {
            if(confirm("Hapus pesanan ini?")) { await client.from('pesanan').delete().eq('id', id); ambilData(); }
        }
        
        async function cek(id, nama, total, method, url) {
            let rp = parseInt(total).toLocaleString('id-ID');
            if(method==='qr') {
                if(!url) return Swal.fire('Info','Belum ada bukti upload','info');
                Swal.fire({title:'BUKTI TRANSFER', text:`Rp ${rp} (a.n ${nama})`, imageUrl:url, imageHeight:400, showCancelButton:true, confirmButtonText:'‚úÖ VALID'}).then(r=>{if(r.isConfirmed) lunas(id)});
            } else {
                Swal.fire({title:'TERIMA TUNAI', text:`Terima Rp ${rp} dari ${nama}?`, icon:'question', showCancelButton:true, confirmButtonText:'YA'}).then(r=>{if(r.isConfirmed) lunas(id)});
            }
        }

        async function lunas(id) { await client.from('pesanan').update({status_bayar:'lunas'}).eq('id',id); ambilData(); }
        async function tutupToko() {
            if(confirm("Tutup toko? Semua data hari ini akan diarsip.")) {
                await client.from('pesanan').update({di_arsip:true}).eq('di_arsip',false);
                ambilData();
            }
        }
        function gantiFilter(s) { filterStatus=s; document.getElementById('judul-list').innerText=s==='pending'?'ANTRIAN':'RIWAYAT'; ambilData(); }
        function print(m,n,i,t,d) {
            let s=`\x1b\x40\x1b\x61\x01\x1b\x21\x30CAFE\n\x1b\x21\x00----------------\nMeja: ${m}\nNama: ${n}\nTgl: ${new Date(d).toLocaleString('id-ID')}\n----------------\n${i}\n----------------\nTOTAL: Rp ${parseInt(t).toLocaleString('id-ID')}\n----------------\nTerima Kasih\n\n\n`;
            window.location.href="rawbt:data="+encodeURIComponent(s);
        }

        client.channel('public:pesanan').on('postgres_changes', {event:'*', schema:'public', table:'pesanan'}, p=>{
            if(p.eventType==='INSERT') { audioNotif.play().catch(e=>{}); Swal.fire({title:'PESANAN MASUK', timer:2000, showConfirmButton:false, icon:'success'}); }
            ambilData();
        }).subscribe();
    </script>
</body>
</html>
