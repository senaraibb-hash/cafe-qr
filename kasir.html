<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MONITOR (GOOGLE VOICE + RAWBT)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes kedip { 0% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } 50% { border-color: #eab308; box-shadow: 0 0 20px #eab308; } 100% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } }
        .pesanan-baru { animation: kedip 1.5s infinite; border-width: 3px; transform: scale(1.02); z-index: 10; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans overflow-x-hidden" onclick="unlockAudio()">

    <script>
        if (sessionStorage.getItem('role') !== 'kasir_valid') {
            alert("ANDA BELUM LOGIN!");
            window.location.href = 'login.html';
        }
    </script>

    <div id="overlay-start" class="fixed inset-0 bg-black/98 z-50 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-500" onclick="mulaiAplikasi()">
        <div class="text-7xl mb-6 animate-bounce text-blue-500"><i class="fa-solid fa-volume-high"></i></div>
        <h1 class="text-4xl font-black text-white mb-2">AKTIFKAN MONITOR</h1>
        <p class="text-gray-400 font-mono">Klik dimana saja untuk sinkronisasi suara & data</p>
    </div>

    <nav class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 z-40 shadow-2xl">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 p-3 rounded-2xl shadow-lg shadow-blue-900/20">
                <i class="fa-solid fa-tv text-2xl text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tighter text-gray-100">MONITOR <span class="text-blue-500">KASIR</span></h1>
                <div id="status-koneksi" class="flex items-center gap-2 text-[10px] text-gray-400 font-bold uppercase tracking-widest">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Connecting...
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="tutupToko()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2.5 rounded-xl text-xs font-black flex items-center gap-2 shadow-lg transition transform active:scale-95 border border-red-400/30">
                <i class="fa-solid fa-archive"></i> TUTUP BUKU
            </button>
            <button onclick="logout()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2.5 rounded-xl border border-gray-600 transition">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 gap-6 mb-10">
            <div onclick="gantiFilter('pending')" class="group bg-gray-800 p-8 rounded-3xl border border-gray-700 cursor-pointer hover:bg-gray-700/50 transition-all shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 p-6 opacity-5 text-yellow-500 group-hover:opacity-20 transition"><i class="fa-solid fa-receipt text-8xl"></i></div>
                <h3 class="text-gray-500 font-black uppercase text-xs tracking-widest mb-2">Antrian Masuk</h3>
                <p id="count-pending" class="text-6xl font-black text-white">0</p>
                <div class="mt-4 w-full bg-gray-900 h-2 rounded-full overflow-hidden">
                    <div class="bg-yellow-500 h-full w-1/2"></div>
                </div>
            </div>
            <div onclick="gantiFilter('lunas')" class="group bg-gray-800 p-8 rounded-3xl border border-gray-700 cursor-pointer hover:bg-gray-700/50 transition-all shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 p-6 opacity-5 text-green-500 group-hover:opacity-20 transition"><i class="fa-solid fa-check-circle text-8xl"></i></div>
                <h3 class="text-gray-500 font-black uppercase text-xs tracking-widest mb-2">Selesai / Lunas</h3>
                <p id="count-lunas" class="text-6xl font-black text-white">0</p>
                <div class="mt-4 w-full bg-gray-900 h-2 rounded-full overflow-hidden">
                    <div class="bg-green-500 h-full w-full"></div>
                </div>
            </div>
        </div>

        <h2 id="judul-list" class="text-2xl font-black mb-6 text-yellow-500 flex items-center gap-3">
            <i class="fa-solid fa-list-ul"></i> DAFTAR ANTRIAN
        </h2>

        <div id="grid-pesanan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full text-center py-32 text-gray-600 bg-gray-800/30 rounded-3xl border-2 border-gray-700 border-dashed animate-pulse">
                Menunggu kiriman data dari pelanggan...
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wythxpljidldaqmrplua.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let audioNotif = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
        let dataPesanan = [];
        let filterStatus = 'pending'; 
        let audioUnlocked = false;

        // --- SISTEM SUARA GOOGLE ---
        function bicaraGoogle(teks) {
            if (!('speechSynthesis' in window)) return;

            // Hentikan suara yang sedang berjalan agar tidak tumpang tindih
            window.speechSynthesis.cancel();

            const msg = new SpeechSynthesisUtterance(teks);
            msg.lang = 'id-ID';
            msg.rate = 0.9; // Kecepatan sedikit lambat agar jelas
            msg.pitch = 1.1; // Nada sedikit tinggi agar terdengar ramah
            
            // Cari voice Google Indonesian
            const voices = window.speechSynthesis.getVoices();
            const googleVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('id'));
            
            if (googleVoice) msg.voice = googleVoice;
            
            window.speechSynthesis.speak(msg);
        }

        // Pancingan agar voices termuat (Chrome butuh ini)
        window.speechSynthesis.getVoices();

        // --- CORE FUNCTIONS ---
        function mulaiAplikasi() {
            document.getElementById('overlay-start').style.display = 'none';
            unlockAudio();
            ambilData();
            bicaraGoogle("Sistem monitor siap menerima pesanan.");
        }

        function unlockAudio() {
            if (!audioUnlocked) {
                audioNotif.play().then(() => { audioNotif.pause(); }).catch(e=>{});
                audioUnlocked = true;
            }
        }

        async function ambilData() {
            const { data, error } = await client
                .from('pesanan')
                .select('*')
                .eq('di_arsip', false) 
                .order('created_at', { ascending: false });

            if (!error) {
                dataPesanan = data || [];
                renderLayar();
                document.getElementById('status-koneksi').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Live Monitoring Active`;
            }
        }

        function renderLayar() {
            const pending = dataPesanan.filter(x => x.status_bayar === 'pending');
            const lunas = dataPesanan.filter(x => x.status_bayar !== 'pending');
            
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-lunas').innerText = lunas.length;

            const listTampil = filterStatus === 'pending' ? pending : lunas;
            const container = document.getElementById('grid-pesanan');

            if (listTampil.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500 font-bold">Tidak ada data ${filterStatus}.</div>`;
                return;
            }

            container.innerHTML = listTampil.map(o => {
                const isBaru = o.status_bayar === 'pending' ? 'pesanan-baru' : '';
                const bgHead = o.status_bayar === 'pending' ? 'bg-yellow-600/20 text-yellow-500' : 'bg-green-600/20 text-green-500';
                const waktu = new Date(o.created_at).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

                return `
                <div class="bg-gray-800 rounded-3xl overflow-hidden border border-gray-700 flex flex-col shadow-2xl transition-all duration-500 ${isBaru}">
                    <div class="p-5 ${bgHead} border-b border-gray-700 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-black uppercase tracking-widest opacity-70">${waktu} | ${o.metode_bayar.toUpperCase()}</span>
                            <h3 class="text-3xl font-black">MEJA ${o.no_meja}</h3>
                        </div>
                        <i class="fa-solid ${o.metode_bayar === 'qr' ? 'fa-qrcode' : 'fa-hand-holding-dollar'} text-2xl"></i>
                    </div>
                    
                    <div class="p-6 flex-grow">
                        <div class="bg-black/30 p-4 rounded-2xl border border-gray-700/50 mb-4">
                            <pre class="whitespace-pre-wrap font-mono text-sm text-gray-300 leading-relaxed">${o.catatan}</pre>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold text-gray-500 uppercase">Pelanggan: ${o.nama_konsumen}</span>
                            <span class="text-xl font-black">Rp ${parseInt(o.total_bayar).toLocaleString('id-ID')}</span>
                        </div>
                    </div>

                    <div class="p-4 bg-gray-900/50 flex gap-2">
                        ${o.status_bayar === 'pending' ? 
                            `<button onclick="cekPembayaran(${o.id}, '${o.nama_konsumen}', ${o.total_bayar}, '${o.metode_bayar}', '${o.bukti_url}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition shadow-lg shadow-blue-900/20 uppercase text-xs tracking-widest">Konfirmasi Bayar</button>` : 
                            `<button onclick="printStruk('${o.no_meja}', '${o.nama_konsumen}', '${o.catatan.replace(/\n/g, '\\n')}', ${o.total_bayar}, '${o.created_at}')" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl transition uppercase text-xs tracking-widest flex justify-center items-center gap-2"><i class="fa-solid fa-print"></i> Re-Print Struk</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        // --- REALTIME LISTENER ---
        client.channel('public:pesanan').on('postgres_changes', { event: '*', schema: 'public', table: 'pesanan' }, (payload) => {
            if (payload.eventType === 'INSERT') {
                const d = payload.new;
                
                // Bunyi Bel
                audioNotif.play().catch(e=>{});

                // Suara Robot Google
                const nominal = parseInt(d.total_bayar).toLocaleString('id-ID');
                const kalimat = `Pesanan baru masuk dari meja ${d.no_meja}. Atas nama ${d.nama_konsumen}. Total tagihan ${nominal} rupiah. Pembayaran melalui ${d.metode_bayar === 'qr' ? 'Q-R-I-S' : 'Tunai'}.`;
                
                // Delay sedikit agar bel selesai bunyi
                setTimeout(() => { bicaraGoogle(kalimat); }, 1000);

                Swal.fire({ 
                    title: 'PESANAN BARU!', 
                    text: `Meja ${d.no_meja} - ${d.nama_konsumen}`, 
                    icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 5000, 
                    background: '#1f2937', color: '#fff' 
                });
            }
            ambilData();
        }).subscribe();

        // --- ACTIONS ---
        async function cekPembayaran(id, nama, total, metode, bukti) {
            let msg = metode === 'qr' ? 'Pastikan Bukti Transfer Benar' : 'Terima uang tunai?';
            const r = await Swal.fire({
                title: 'Validasi Bayar',
                text: `${msg} - Rp ${total.toLocaleString('id-ID')}`,
                imageUrl: bukti || null,
                imageHeight: bukti ? 300 : null,
                showCancelButton: true,
                confirmButtonText: 'YA, LUNAS',
                confirmButtonColor: '#10B981',
                background: '#1f2937', color: '#fff'
            });

            if (r.isConfirmed) {
                await client.from('pesanan').update({ status_bayar: 'lunas' }).eq('id', id);
                ambilData();
                bicaraGoogle("Pembayaran berhasil dikonfirmasi.");
            }
        }

        function gantiFilter(s) {
            filterStatus = s;
            document.getElementById('judul-list').innerText = s === 'pending' ? "DAFTAR ANTRIAN" : "RIWAYAT SELESAI";
            renderLayar();
        }

        async function tutupToko() {
            const r = await Swal.fire({
                title: 'TUTUP BUKU?',
                text: "Semua antrian akan diarsipkan dan layar akan dibersihkan.",
                icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Tutup!', background: '#1f2937', color: '#fff'
            });
            if (r.isConfirmed) {
                await client.from('pesanan').update({ di_arsip: true }).eq('di_arsip', false);
                ambilData();
            }
        }

        function logout() { sessionStorage.removeItem('role'); window.location.href = 'login.html'; }

        // --- PRINTING RAWBT ---
        function printStruk(meja, nama, items, total, tgl) {
            let s = `\x1b\x40\x1b\x61\x01\x1b\x21\x30CAFE KAMI\n\x1b\x21\x00Struk Pesanan\n--------------------------------\n\x1b\x61\x00Meja  : ${meja}\nNama  : ${nama}\nWaktu : ${new Date(tgl).toLocaleString('id-ID')}\n--------------------------------\n${items}\n--------------------------------\n\x1b\x61\x02\x1b\x21\x10TOTAL : Rp ${parseInt(total).toLocaleString('id-ID')}\n\x1b\x21\x00--------------------------------\n\x1b\x61\x01Terima Kasih!\n\n\n\n`;
            window.location.href = "rawbt:data=" + encodeURIComponent(s);
        }

    </script>
</body>
</html>
