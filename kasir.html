<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MONITOR PRO - GOOGLE VOICE & RAWBT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes kedip-border { 
            0% { border-color: #ef4444; box-shadow: 0 0 5px #ef4444; } 
            50% { border-color: #eab308; box-shadow: 0 0 20px #eab308; } 
            100% { border-color: #ef4444; box-shadow: 0 0 5px #ef4444; } 
        }
        .pesanan-baru { animation: kedip-border 1.5s infinite; border-width: 3px; transform: scale(1.01); z-index: 10; }
        body { background-color: #0f172a; scroll-behavior: smooth; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-white min-h-screen font-sans">

    <script>
        if (sessionStorage.getItem('role') !== 'kasir_valid') {
            window.location.href = 'login.html';
        }
    </script>

    <div id="overlay-start" class="fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center cursor-pointer text-center" onclick="mulaiAplikasi()">
        <div class="bg-blue-600 w-28 h-28 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-2xl shadow-blue-500/40">
            <i class="fa-solid fa-play text-4xl ml-2"></i>
        </div>
        <h1 class="text-3xl font-black tracking-tighter mb-2">AKTIFKAN MONITOR</h1>
        <p class="text-slate-500 text-xs uppercase tracking-[0.3em]">Klik untuk Sinkronisasi Suara & Data</p>
    </div>

    <nav class="bg-slate-900/80 border-b border-slate-800 p-4 sticky top-0 z-40 glass shadow-2xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-900/40">
                    <i class="fa-solid fa-desktop text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black leading-none tracking-tight">KASIR <span class="text-blue-500">MONITOR</span></h1>
                    <div id="status-koneksi" class="flex items-center gap-2 text-[10px] text-slate-500 font-bold mt-1 uppercase tracking-widest">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Offline
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="testSuara()" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-xs font-bold transition border border-slate-700">
                    <i class="fa-solid fa-bullhorn mr-2"></i> TES SUARA
                </button>
                <button onclick="tutupToko()" class="px-5 py-3 bg-red-600 hover:bg-red-500 rounded-xl text-xs font-black shadow-lg shadow-red-900/20 transition border border-red-400/20 uppercase">
                    Tutup Buku
                </button>
            </div>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 gap-6 mb-10">
            <div onclick="gantiFilter('pending')" id="tab-pending" class="bg-slate-800 p-8 rounded-[2.5rem] border-2 border-yellow-500 cursor-pointer shadow-2xl relative transition-all active:scale-95">
                <h3 class="text-slate-500 font-black uppercase text-xs tracking-widest mb-2">Antrean Masuk</h3>
                <p id="count-pending" class="text-6xl font-black italic">0</p>
                <div class="absolute top-6 right-8 text-yellow-500/20"><i class="fa-solid fa-receipt text-6xl"></i></div>
            </div>
            <div onclick="gantiFilter('lunas')" id="tab-lunas" class="bg-slate-800 p-8 rounded-[2.5rem] border-2 border-transparent cursor-pointer shadow-2xl relative transition-all active:scale-95 opacity-60">
                <h3 class="text-slate-500 font-black uppercase text-xs tracking-widest mb-2">Sudah Selesai</h3>
                <p id="count-lunas" class="text-6xl font-black italic">0</p>
                <div class="absolute top-6 right-8 text-green-500/20"><i class="fa-solid fa-check-circle text-6xl"></i></div>
            </div>
        </div>

        <h2 id="judul-list" class="text-2xl font-black mb-8 flex items-center gap-3 tracking-tighter text-yellow-500">
            <i class="fa-solid fa-bolt"></i> DAFTAR ANTRIAN DAPUR
        </h2>

        <div id="grid-pesanan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full py-20 text-center text-slate-600 border-2 border-dashed border-slate-800 rounded-[3rem]">
                <p class="italic">Menghubungkan ke database...</p>
            </div>
        </div>
    </div>

    <script>
        const SUP_URL = 'https://wythxpljidldaqmrplua.supabase.co';
        const SUP_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb';
        const client = supabase.createClient(SUP_URL, SUP_KEY);

        let bell = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        let dataPesanan = [];
        let filterStatus = 'pending';
        let audioOk = false;

        // --- GOOGLE VOICE ENGINE ---
        function bicara(teks) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(teks);
            msg.lang = 'id-ID';
            msg.rate = 0.95; 
            msg.pitch = 1.0;
            const voices = window.speechSynthesis.getVoices();
            const gVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('id'));
            if (gVoice) msg.voice = gVoice;
            window.speechSynthesis.speak(msg);
        }

        function mulaiAplikasi() {
            document.getElementById('overlay-start').style.display = 'none';
            if (!audioOk) {
                bell.play().then(() => bell.pause());
                audioOk = true;
            }
            ambilData();
            bicara("Sistem monitor diaktifkan.");
        }

        function testSuara() {
            bicara("Tes suara Google berhasil. Sistem siap menerima pesanan.");
        }

        async function ambilData() {
            const { data, error } = await client.from('pesanan').select('*').eq('di_arsip', false).order('created_at', { ascending: false });
            if (!error) {
                dataPesanan = data || [];
                renderLayar();
                document.getElementById('status-koneksi').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Live Monitoring`;
            }
        }

        function renderLayar() {
            const pending = dataPesanan.filter(x => x.status_bayar === 'pending');
            const lunas = dataPesanan.filter(x => x.status_bayar !== 'pending');
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-lunas').innerText = lunas.length;

            const list = filterStatus === 'pending' ? pending : lunas;
            const container = document.getElementById('grid-pesanan');

            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-slate-700 font-bold uppercase tracking-widest border-2 border-dashed border-slate-800 rounded-[3rem]">Belum Ada Data</div>`;
                return;
            }

            container.innerHTML = list.map(o => {
                const isBaru = o.status_bayar === 'pending' ? 'pesanan-baru' : '';
                const jam = new Date(o.created_at).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                const rupiah = parseInt(o.total_bayar).toLocaleString('id-ID');
                const isQR = o.metode_bayar === 'qr';

                return `
                <div class="bg-slate-800 rounded-[2.5rem] overflow-hidden border border-slate-700 shadow-2xl flex flex-col transition-all duration-300 ${isBaru}">
                    <div class="p-6 ${o.status_bayar === 'pending' ? 'bg-yellow-500/5' : 'bg-green-500/5'} border-b border-slate-700 flex justify-between items-start">
                        <div>
                            <span class="text-[9px] font-black text-slate-500 block uppercase tracking-[0.2em] mb-1">${isQR ? 'QRIS PAYMENT' : 'CASH PAYMENT'}</span>
                            <h3 class="text-4xl font-black tracking-tighter">MEJA ${o.no_meja}</h3>
                            <p class="text-sm font-bold text-blue-400 mt-1 uppercase">${o.nama_konsumen}</p>
                        </div>
                        <span class="text-[10px] font-mono text-slate-600 bg-slate-950 px-3 py-1 rounded-full">${jam}</span>
                    </div>

                    <div class="p-7 flex-grow">
                        <div class="bg-slate-900/50 p-5 rounded-3xl border border-slate-700/50 shadow-inner min-h-[100px]">
                            <pre class="whitespace-pre-wrap font-mono text-sm text-slate-300 leading-relaxed">${o.catatan}</pre>
                        </div>
                    </div>

                    <div class="p-6 bg-slate-900/50 border-t border-slate-700 flex flex-col gap-3">
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total Tagihan</span>
                            <span class="text-2xl font-black">Rp ${rupiah}</span>
                        </div>

                        ${o.status_bayar === 'pending' && isQR ? 
                            `<button onclick="lihatBukti('${o.bukti_url}')" class="w-full bg-amber-500 hover:bg-amber-400 text-white font-black py-3 rounded-2xl transition shadow-lg text-xs uppercase tracking-widest">
                                <i class="fa-solid fa-camera mr-2"></i> Cek Bukti TF
                            </button>` : ''
                        }

                        <div class="flex gap-3">
                        ${o.status_bayar === 'pending' ? 
                            `<button onclick="konfirmasiLunas(${o.id}, ${o.total_bayar})" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition shadow-lg text-xs uppercase tracking-widest">Konfirmasi</button>` : 
                            `<button onclick="printLagi('${o.no_meja}', '${o.nama_konsumen}', '${o.catatan.replace(/\n/g, '\\n')}', ${o.total_bayar}, '${o.created_at}')" class="flex-1 bg-slate-700 hover:bg-white hover:text-black text-white font-black py-4 rounded-2xl transition text-xs uppercase flex items-center justify-center gap-2 border border-slate-600"><i class="fa-solid fa-print"></i> Print Struk</button>`
                        }
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- REALTIME ENGINE ---
        client.channel('monitor-pro').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pesanan' }, (payload) => {
            const d = payload.new;
            bell.play().catch(e => {});
            setTimeout(() => {
                bicara(`Pesanan baru. Meja ${d.no_meja}. Atas nama ${d.nama_konsumen}.`);
            }, 800);
            ambilData();
        }).subscribe();

        // --- ACTIONS ---
        function lihatBukti(url) {
            if (!url || url === "null") return Swal.fire('Gagal', 'Konsumen belum upload bukti.', 'error');
            Swal.fire({
                title: 'Bukti Pembayaran',
                imageUrl: url,
                confirmButtonText: 'TUTUP',
                background: '#1e293b', color: '#fff'
            });
        }

        async function konfirmasiLunas(id, total) {
            const r = await Swal.fire({ 
                title: 'Selesaikan?', text: `Tagihan Rp ${total.toLocaleString()}`, 
                icon: 'question', showCancelButton: true, confirmButtonText: 'YA, LUNAS',
                confirmButtonColor: '#10B981', background: '#1e293b', color: '#fff' 
            });
            if (r.isConfirmed) { 
                await client.from('pesanan').update({ status_bayar: 'lunas' }).eq('id', id); 
                ambilData(); 
                bicara("Pesanan diproses.");
            }
        }

        async function tutupToko() {
            const { value: pin } = await Swal.fire({ 
                title: 'Tutup Shift?', text: "Data akan dipindahkan ke arsip.", 
                input: 'password', inputPlaceholder: 'PIN Owner',
                showCancelButton: true, background: '#1e293b', color: '#fff'
            });
            if (pin === '1234') {
                await client.from('pesanan').update({ di_arsip: true }).eq('di_arsip', false);
                ambilData();
                Swal.fire('Berhasil', 'Antrean dikosongkan.', 'success');
            }
        }

        function gantiFilter(s) {
            filterStatus = s;
            document.getElementById('judul-list').innerText = s === 'pending' ? 'DAFTAR ANTRIAN DAPUR' : 'RIWAYAT SELESAI HARI INI';
            document.getElementById('tab-pending').classList.toggle('border-yellow-500', s === 'pending');
            document.getElementById('tab-pending').classList.toggle('opacity-60', s !== 'pending');
            document.getElementById('tab-lunas').classList.toggle('border-green-500', s === 'lunas');
            document.getElementById('tab-lunas').classList.toggle('opacity-60', s !== 'lunas');
            renderLayar();
        }

        // --- PRINTING ENGINE (RAWBT) ---
        function printLagi(meja, nama, items, total, tgl) {
            const d = new Date(tgl).toLocaleString('id-ID');
            const tot = parseInt(total).toLocaleString('id-ID');
            // Format Struk Thermal 58mm
            let s = "";
            s += "\x1b\x40"; // Init
            s += "\x1b\x61\x01"; // Center
            s += "\x1b\x21\x30CAFE KAMI\n"; // Double height & width
            s += "\x1b\x21\x00STRUK PEMBAYARAN\n";
            s += "--------------------------------\n";
            s += "\x1b\x61\x00"; // Left
            s += `MEJA  : ${meja}\n`;
            s += `NAMA  : ${nama}\n`;
            s += `WAKTU : ${d}\n`;
            s += "--------------------------------\n";
            s += `${items}\n`;
            s += "--------------------------------\n";
            s += "\x1b\x61\x02"; // Right
            s += `\x1b\x21\x10TOTAL : Rp ${tot}\n`;
            s += "\x1b\x21\x00"; // Normal
            s += "--------------------------------\n";
            s += "\x1b\x61\x01"; // Center
            s += "Terima Kasih!\n\n\n\n\x1d\x56\x00"; // Cut
            
            window.location.href = "rawbt:data=" + encodeURIComponent(s);
        }
    </script>
</body>
</html>
