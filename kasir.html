<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITOR KASIR (GOOGLE VOICE OK)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes kedip { 0% { border-color: #ef4444; } 50% { border-color: #eab308; } 100% { border-color: #ef4444; } }
        .pesanan-baru { animation: kedip 1.5s infinite; border-width: 3px; transform: scale(1.02); }
        body { background-color: #0f172a; }
    </style>
</head>
<body class="text-white min-h-screen font-sans overflow-x-hidden">

    <script>
        if (sessionStorage.getItem('role') !== 'kasir_valid') {
            alert("ANDA BELUM LOGIN!");
            window.location.href = 'login.html';
        }
    </script>

    <div id="overlay-start" class="fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center cursor-pointer text-center p-6" onclick="mulaiAplikasi()">
        <div class="bg-blue-600 w-32 h-32 rounded-full flex items-center justify-center mb-6 animate-pulse shadow-lg shadow-blue-500/50">
            <i class="fa-solid fa-volume-high text-5xl"></i>
        </div>
        <h1 class="text-3xl font-black text-white mb-2 tracking-tighter">AKTIFKAN SUARA & DATA</h1>
        <p class="text-gray-400 max-w-xs uppercase text-[10px] tracking-widest font-bold">Klik layar untuk mengizinkan suara Google dan memuat antrian</p>
    </div>

    <nav class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center sticky top-0 z-40 shadow-xl">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-desktop text-2xl text-blue-500"></i>
            <div>
                <h1 class="text-lg font-black leading-none">MONITOR KASIR</h1>
                <span id="status-koneksi" class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Menghubungkan...</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="testSuara()" class="bg-slate-700 text-gray-300 px-3 py-1.5 rounded-lg text-[10px] font-bold border border-slate-600 hover:bg-slate-600">
                <i class="fa-solid fa-vial"></i> TES SUARA
            </button>
            <button onclick="tutupToko()" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-lg hover:bg-red-500">
                TUTUP BUKU
            </button>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div onclick="gantiFilter('pending')" class="bg-slate-800 p-6 rounded-2xl border border-slate-700 cursor-pointer hover:border-yellow-500 transition shadow-lg">
                <h3 class="text-gray-500 font-bold uppercase text-[10px] tracking-widest mb-1">Antrian</h3>
                <p id="count-pending" class="text-5xl font-black">0</p>
            </div>
            <div onclick="gantiFilter('lunas')" class="bg-slate-800 p-6 rounded-2xl border border-slate-700 cursor-pointer hover:border-green-500 transition shadow-lg">
                <h3 class="text-gray-500 font-bold uppercase text-[10px] tracking-widest mb-1">Lunas</h3>
                <p id="count-lunas" class="text-5xl font-black">0</p>
            </div>
        </div>

        <h2 id="judul-list" class="text-xl font-black text-yellow-500 mb-6 flex items-center gap-2">
            <i class="fa-solid fa-clock-rotate-left"></i> DAFTAR ANTRIAN
        </h2>

        <div id="grid-pesanan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 text-slate-600">Memuat data...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wythxpljidldaqmrplua.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let audioBell = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
        let dataPesanan = [];
        let filterStatus = 'pending';
        let audioUnlocked = false;

        // --- GOOGLE VOICE ENGINE ---
        function bicara(teks) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel(); // Matikan suara yang sedang jalan agar tidak menumpuk

            const msg = new SpeechSynthesisUtterance(teks);
            msg.lang = 'id-ID';
            msg.rate = 0.9; 
            msg.pitch = 1.0;

            // Cari suara Google Indonesian
            const voices = window.speechSynthesis.getVoices();
            const voiceGoogle = voices.find(v => v.name.includes('Google') && v.lang.includes('id'));
            if (voiceGoogle) msg.voice = voiceGoogle;

            window.speechSynthesis.speak(msg);
        }

        // --- CORE ---
        function mulaiAplikasi() {
            document.getElementById('overlay-start').style.display = 'none';
            if (!audioUnlocked) {
                audioBell.play().then(() => audioBell.pause());
                audioUnlocked = true;
            }
            ambilData();
            bicara("Sistem aktif. Monitor siap menerima pesanan.");
        }

        function testSuara() {
            bicara("Tes suara. Satu, dua, tiga. Google Bahasa Indonesia aktif.");
        }

        async function ambilData() {
            const { data, error } = await client.from('pesanan').select('*').eq('di_arsip', false).order('created_at', { ascending: false });
            if (!error) {
                dataPesanan = data || [];
                renderLayar();
                document.getElementById('status-koneksi').innerHTML = `ONLINE | ${new Date().toLocaleTimeString()}`;
            }
        }

        function renderLayar() {
            const pending = dataPesanan.filter(x => x.status_bayar === 'pending');
            const lunas = dataPesanan.filter(x => x.status_bayar !== 'pending');
            
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-lunas').innerText = lunas.length;

            const list = filterStatus === 'pending' ? pending : lunas;
            const container = document.getElementById('grid-pesanan');

            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-slate-600 italic">Belum ada pesanan ${filterStatus}</div>`;
                return;
            }

            container.innerHTML = list.map(o => {
                const isBaru = o.status_bayar === 'pending' ? 'pesanan-baru' : '';
                const nominal = parseInt(o.total_bayar).toLocaleString('id-ID');
                
                return `
                <div class="bg-slate-800 rounded-3xl overflow-hidden border border-slate-700 shadow-2xl flex flex-col ${isBaru}">
                    <div class="p-5 ${o.status_bayar === 'pending' ? 'bg-yellow-600/10' : 'bg-green-600/10'} border-b border-slate-700 flex justify-between items-start">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 block uppercase tracking-widest">${o.metode_bayar === 'qr' ? 'ðŸ’³ QRIS' : 'ðŸ’µ TUNAI'}</span>
                            <h3 class="text-3xl font-black">MEJA ${o.no_meja}</h3>
                            <p class="text-sm text-gray-300 font-bold">${o.nama_konsumen}</p>
                        </div>
                        <div class="text-right text-[10px] text-gray-500 font-mono">${new Date(o.created_at).toLocaleTimeString('id-ID')}</div>
                    </div>
                    
                    <div class="p-6 flex-grow bg-slate-800/50">
                        <pre class="whitespace-pre-wrap font-mono text-sm text-gray-300 mb-6 border-l-2 border-slate-600 pl-4">${o.catatan}</pre>
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total</span>
                            <span class="text-2xl font-black text-white">Rp ${nominal}</span>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-900 flex gap-2">
                        ${o.status_bayar === 'pending' ? 
                            `<button onclick="konfirmasiLunas(${o.id})" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition shadow-lg text-xs tracking-widest uppercase">Konfirmasi Bayar</button>` : 
                            `<button onclick="printLagi('${o.no_meja}', '${o.nama_konsumen}', '${o.catatan.replace(/\n/g, '\\n')}', ${o.total_bayar}, '${o.created_at}')" class="w-full bg-slate-700 text-white font-black py-4 rounded-2xl transition text-xs tracking-widest uppercase flex items-center justify-center gap-2"><i class="fa-solid fa-print"></i> Re-Print</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        // --- REALTIME ---
        client.channel('monitor-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pesanan' }, (payload) => {
            const d = payload.new;
            
            // 1. Bunyi Bel
            audioBell.play().catch(e => console.log("Audio diblokir browser. Butuh klik layar."));

            // 2. Suara Robot Google
            const nominal = parseInt(d.total_bayar).toLocaleString('id-ID');
            const teksNotif = `Pesanan baru dari meja ${d.no_meja}. Atas nama ${d.nama_konsumen}. Total tagihan ${nominal} rupiah. Pembayaran ${d.metode_bayar === 'qr' ? 'melalui Q R I S' : 'secara tunai'}.`;
            
            setTimeout(() => bicara(teksNotif), 1000);

            ambilData();
        }).subscribe();

        // --- ACTIONS ---
        async function konfirmasiLunas(id) {
            const r = await Swal.fire({ title: 'Konfirmasi?', text: "Pastikan uang/transfer sudah masuk!", icon: 'question', showCancelButton: true, confirmButtonColor: '#10B981', background: '#1e293b', color: '#fff' });
            if (r.isConfirmed) { await client.from('pesanan').update({ status_bayar: 'lunas' }).eq('id', id); ambilData(); bicara("Pembayaran diterima."); }
        }

        async function tutupToko() {
            const r = await Swal.fire({ title: 'Tutup Toko?', text: "Semua pesanan di layar akan diarsipkan ke Owner.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', background: '#1e293b', color: '#fff' });
            if (r.isConfirmed) { await client.from('pesanan').update({ di_arsip: true }).eq('di_arsip', false); ambilData(); }
        }

        function gantiFilter(s) { filterStatus = s; document.getElementById('judul-list').innerText = s === 'pending' ? 'DAFTAR ANTRIAN' : 'RIWAYAT SELESAI'; renderLayar(); }

        function printLagi(meja, nama, items, total, tgl) {
            let s = `\x1b\x40\x1b\x61\x01\x1b\x21\x30RE-PRINT\n\x1b\x21\x00--------------------------------\n\x1b\x61\x00Meja : ${meja}\nNama : ${nama}\n--------------------------------\n${items}\n--------------------------------\n\x1b\x61\x02TOTAL: Rp ${parseInt(total).toLocaleString('id-ID')}\n\n\n\n`;
            window.location.href = "rawbt:data=" + encodeURIComponent(s);
        }
    </script>
</body>
</html>
