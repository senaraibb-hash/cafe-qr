<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWNER DASHBOARD (PRO)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <script>
        if (sessionStorage.getItem('role') !== 'owner_valid') {
            alert("AKSES DITOLAK: KHUSUS OWNER!");
            window.location.href = 'login.html';
        }
    </script>

    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-user-tie text-2xl"></i>
                <div>
                    <h1 class="font-bold text-xl tracking-wider">OWNER PANEL</h1>
                    <p class="text-[10px] text-blue-200">Laporan & Manajemen Menu</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-400 px-4 py-2 rounded text-sm font-bold shadow transition">LOGOUT</button>
        </div>
    </nav>

    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto flex">
            <button onclick="gantiTab('laporan')" id="tab-laporan" class="flex-1 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50 transition"><i class="fa-solid fa-chart-line mr-2"></i> LAPORAN KEUANGAN</button>
            <button onclick="gantiTab('menu')" id="tab-menu" class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 transition"><i class="fa-solid fa-utensils mr-2"></i> KELOLA MENU</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">

        <div id="view-laporan">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-file-invoice text-green-600"></i> EXPORT & CETAK</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button onclick="downloadCSV('hari')" class="bg-green-100 text-green-800 py-2 px-4 rounded-lg text-sm font-bold hover:bg-green-200 border border-green-200 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> Harian</button>
                    <button onclick="downloadCSV('minggu')" class="bg-blue-100 text-blue-800 py-2 px-4 rounded-lg text-sm font-bold hover:bg-blue-200 border border-blue-200 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> Mingguan</button>
                    <button onclick="downloadCSV('bulan')" class="bg-indigo-100 text-indigo-800 py-2 px-4 rounded-lg text-sm font-bold hover:bg-indigo-200 border border-indigo-200 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> Bulanan</button>
                    <button onclick="cetakStrukHarian()" class="col-span-2 md:col-span-1 bg-orange-600 text-white py-2 px-4 rounded-lg text-sm font-bold hover:bg-orange-500 border border-orange-600 flex items-center justify-center gap-2 shadow-md"><i class="fa-solid fa-print"></i> STRUK HARIAN</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Omzet Hari Ini</p>
                    <h3 id="omzet-hari" class="text-3xl font-black text-blue-900 mt-2">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Omzet Bulan Ini</p>
                    <h3 id="omzet-bulan" class="text-3xl font-black text-green-900 mt-2">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                    <p class="text-gray-500 text-xs font-bold uppercase">Total Transaksi (Tahun)</p>
                    <h3 id="total-trx" class="text-3xl font-black text-purple-900 mt-2">0</h3>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-10">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">RIWAYAT PESANAN (LUNAS)</h2>
                    <button onclick="initLaporan()" class="text-sm text-blue-600 hover:underline"><i class="fa-solid fa-sync"></i> Refresh</button>
                </div>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-left border-collapse text-sm">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0">
                            <tr>
                                <th class="p-4 border-b">Waktu</th>
                                <th class="p-4 border-b">Detail</th>
                                <th class="p-4 border-b">Metode</th>
                                <th class="p-4 border-b text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-laporan"><tr><td colspan="4" class="p-8 text-center">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <h3 class="text-red-700 font-bold mb-2"><i class="fa-solid fa-triangle-exclamation"></i> DANGER ZONE</h3>
                <button onclick="hapusSemuaRiwayat()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow transition">HAPUS SEMUA RIWAYAT</button>
            </div>
            <br><br>
        </div>

        <div id="view-menu" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border border-gray-200">
                <h3 class="font-bold text-lg mb-4 text-gray-700 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-green-600"></i> TAMBAH MENU</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="nama-menu" placeholder="Nama Menu" class="p-3 border rounded-lg w-full">
                    <input type="number" id="harga-menu" placeholder="Harga" class="p-3 border rounded-lg w-full">
                    <select id="kategori-menu" class="p-3 border rounded-lg w-full">
                        <option value="makanan">Makanan</option>
                        <option value="minuman">Minuman</option>
                        <option value="snack">Snack</option>
                    </select>
                    <input type="text" id="gambar-menu" placeholder="Link Gambar (URL)" class="p-3 border rounded-lg w-full">
                </div>
                <button onclick="tambahMenu()" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow transition">SIMPAN MENU</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="list-menu"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wythxpljidldaqmrplua.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_gyKCFApEbb42xicDzLDGMw_L0W4lzyb'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function gantiTab(tab) {
            const btnLap = document.getElementById('tab-laporan'); const btnMen = document.getElementById('tab-menu');
            const viewLap = document.getElementById('view-laporan'); const viewMen = document.getElementById('view-menu');
            if (tab === 'laporan') {
                viewLap.classList.remove('hidden'); viewMen.classList.add('hidden');
                btnLap.className = "flex-1 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50 transition";
                btnMen.className = "flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 transition";
                initLaporan();
            } else {
                viewLap.classList.add('hidden'); viewMen.classList.remove('hidden');
                btnMen.className = "flex-1 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50 transition";
                btnLap.className = "flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 transition";
                initMenu();
            }
        }
        function logout() { sessionStorage.removeItem('role'); window.location.href = 'login.html'; }

        // --- DASHBOARD DATA ---
        async function initLaporan() {
            const { data } = await client.from('pesanan').select('*').eq('status_bayar', 'lunas').order('created_at', { ascending: false }).limit(50);
            
            const now = new Date();
            const { data: allData } = await client.from('pesanan').select('total_bayar, created_at').eq('status_bayar', 'lunas');
            
            const dHari = allData.filter(d => new Date(d.created_at).toDateString() === now.toDateString());
            const dBulan = allData.filter(d => new Date(d.created_at).getMonth() === now.getMonth() && new Date(d.created_at).getFullYear() === now.getFullYear());
            const dYear = allData.filter(d => new Date(d.created_at).getFullYear() === now.getFullYear());

            document.getElementById('omzet-hari').innerText = 'Rp ' + dHari.reduce((a,b)=>a+b.total_bayar,0).toLocaleString('id-ID');
            document.getElementById('omzet-bulan').innerText = 'Rp ' + dBulan.reduce((a,b)=>a+b.total_bayar,0).toLocaleString('id-ID');
            document.getElementById('total-trx').innerText = dYear.length;
            
            renderTabel(data || []);
        }

        function renderTabel(data) {
            const tbody = document.getElementById('tabel-laporan');
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Belum ada data penjualan.</td></tr>'; return; }
            tbody.innerHTML = data.map(d => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 text-gray-500">${new Date(d.created_at).toLocaleString('id-ID')}</td>
                    <td class="p-4"><b>Meja ${d.no_meja}</b> (${d.nama_konsumen})</td>
                    <td class="p-4">${d.metode_bayar==='qr'?'<span class="text-blue-600 font-bold">QRIS</span>':'<span class="text-orange-600 font-bold">TUNAI</span>'}</td>
                    <td class="p-4 text-right font-bold">Rp ${parseInt(d.total_bayar).toLocaleString('id-ID')}</td>
                </tr>`).join('');
        }

        // --- FUNGSI CETAK STRUK HARIAN (BARU) ---
        async function cetakStrukHarian() {
            const now = new Date();
            const startStr = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString();
            const endStr = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).toISOString();

            // Ambil data hari ini saja
            const { data } = await client.from('pesanan').select('*').eq('status_bayar', 'lunas').gte('created_at', startStr).lte('created_at', endStr);

            if(!data || data.length === 0) return Swal.fire('Data Kosong', 'Belum ada transaksi hari ini.', 'info');

            // Hitung Rekap
            let totalOmzet = 0;
            let totalCash = 0;
            let totalQR = 0;
            let totalTrx = data.length;

            data.forEach(d => {
                totalOmzet += d.total_bayar;
                if(d.metode_bayar === 'qr') totalQR += d.total_bayar;
                else totalCash += d.total_bayar;
            });

            // Format Tampilan HTML (Untuk Popup)
            const tglIndo = now.toLocaleString('id-ID');
            const strukHTML = `
                <div class="text-left font-mono text-sm leading-relaxed p-2 bg-white text-black border-2 border-dashed border-gray-300">
                    <div class="text-center font-bold mb-2 pb-2 border-b border-dashed border-gray-400">
                        LAPORAN HARIAN<br>${tglIndo}
                    </div>
                    <div class="flex justify-between"><span>Total Trx:</span> <b>${totalTrx}</b></div>
                    <div class="border-t border-dashed border-gray-300 my-1"></div>
                    <div class="flex justify-between text-green-700"><span>QRIS (Bank):</span> <b>Rp ${totalQR.toLocaleString('id-ID')}</b></div>
                    <div class="flex justify-between text-orange-700"><span>TUNAI (Laci):</span> <b>Rp ${totalCash.toLocaleString('id-ID')}</b></div>
                    <div class="border-t border-black my-1"></div>
                    <div class="flex justify-between text-lg font-black"><span>TOTAL:</span> <span>Rp ${totalOmzet.toLocaleString('id-ID')}</span></div>
                    <div class="text-center mt-2 text-xs text-gray-500">Dicetak oleh Owner Panel</div>
                </div>
            `;

            // Tampilkan Pilihan Cetak
            Swal.fire({
                title: 'STRUK HARIAN',
                html: strukHTML,
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-print"></i> PRINT RAWBT (HP)',
                denyButtonText: '<i class="fa-solid fa-file-pdf"></i> PRINT BIASA (PC)',
                confirmButtonColor: '#ea580c',
                denyButtonColor: '#3b82f6',
                cancelButtonText: 'Tutup'
            }).then((result) => {
                if (result.isConfirmed) {
                    // PRINT RAWBT (ESC/POS)
                    let raw = `\x1b\x40\x1b\x61\x01\x1b\x21\x10LAPORAN HARIAN\n\x1b\x21\x00${tglIndo}\n--------------------------------\n\x1b\x61\x00Total Trx : ${totalTrx}\n--------------------------------\nQRIS (Bank): Rp ${totalQR.toLocaleString('id-ID')}\nTunai(Laci): Rp ${totalCash.toLocaleString('id-ID')}\n--------------------------------\n\x1b\x21\x10TOTAL     : Rp ${totalOmzet.toLocaleString('id-ID')}\n\x1b\x21\x00--------------------------------\n\x1b\x61\x01Owner Panel\n\n\n`;
                    window.location.href = "rawbt:data=" + encodeURIComponent(raw);
                } else if (result.isDenied) {
                    // PRINT BROWSER BIASA
                    let printWindow = window.open('', '', 'height=600,width=400');
                    printWindow.document.write('<html><head><title>Laporan Harian</title></head><body >');
                    printWindow.document.write(strukHTML);
                    printWindow.document.write('<script>window.print(); window.close();<\/script>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                }
            });
        }

        // --- CSV DOWNLOAD ---
        async function downloadCSV(periode) {
            let startDate, endDate;
            const now = new Date(); 
            if (periode === 'hari') { startDate = new Date(now.setHours(0,0,0,0)); endDate = new Date(now.setHours(23,59,59,999)); }
            else if (periode === 'minggu') { endDate = new Date(); startDate = new Date(); startDate.setDate(endDate.getDate() - 7); }
            else if (periode === 'bulan') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); }
            else if (periode === 'tahun') { startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); }

            const { data, error } = await client.from('pesanan').select('*').eq('status_bayar', 'lunas').gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString()).order('created_at', { ascending: true });
            if (error || !data || data.length === 0) return Swal.fire('Kosong', 'Tidak ada data', 'info');

            let totalOmzet = 0;
            let csv = "sep=;\nWAKTU;MEJA;KONSUMEN;METODE BAYAR;TOTAL BAYAR;CATATAN\n";
            data.forEach(d => {
                totalOmzet += Number(d.total_bayar);
                let cleanNote = (d.catatan || '').replace(/(\r\n|\n|\r)/gm,' | ').replace(/;/g, ',');
                csv += `"${new Date(d.created_at).toLocaleString('id-ID')}";"${d.no_meja}";"${d.nama_konsumen}";"${d.metode_bayar === 'qr' ? 'QRIS' : 'TUNAI'}";"${d.total_bayar}";"${cleanNote}"\n`;
            });
            csv += `\n;;;;TOTAL OMZET;"${totalOmzet}"\n`;

            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `Laporan_${periode}_${Date.now()}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        async function hapusSemuaRiwayat() {
            const { value: konfirmasi } = await Swal.fire({ title: 'HAPUS SEMUA DATA?', text: "Ketik 'KONFIRMASI'", input: 'text', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
            if (konfirmasi === 'KONFIRMASI') {
                const { error } = await client.from('pesanan').delete().neq('id', 0);
                if (!error) { Swal.fire('TERHAPUS', 'Data bersih.', 'success'); initLaporan(); }
            }
        }

        // --- MENU LOGIC ---
        async function initMenu() {
            const container = document.getElementById('list-menu');
            const { data } = await client.from('menu').select('*').order('id', {ascending: false});
            if (!data || data.length === 0) { container.innerHTML = '<div class="text-center col-span-full">Belum ada menu.</div>'; return; }
            container.innerHTML = data.map(m => `
                <div class="bg-white rounded-xl shadow border p-4 relative group">
                    <img src="${m.gambar}" class="w-full h-32 object-cover rounded bg-gray-200 mb-2">
                    <button onclick="hapusMenu(${m.id})" class="absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full shadow hover:bg-red-700"><i class="fa-solid fa-trash"></i></button>
                    <h4 class="font-bold">${m.nama}</h4> <p class="text-orange-600 font-bold">Rp ${m.harga.toLocaleString()}</p>
                    <button onclick="toggleStok(${m.id}, ${m.tersedia})" class="mt-2 w-full py-1 text-xs font-bold rounded ${m.tersedia?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${m.tersedia?'TERSEDIA':'HABIS'}</button>
                </div>`).join('');
        }

        async function tambahMenu() {
            const nama = document.getElementById('nama-menu').value; const harga = document.getElementById('harga-menu').value;
            const kat = document.getElementById('kategori-menu').value; const img = document.getElementById('gambar-menu').value;
            if(!nama || !harga) return Swal.fire('Isi nama & harga!', '', 'warning');
            await client.from('menu').insert([{nama, harga:parseInt(harga), kategori:kat, gambar:img||'https://via.placeholder.com/150', tersedia:true}]);
            document.getElementById('nama-menu').value = ''; document.getElementById('harga-menu').value = '';
            Swal.fire('Sukses','Menu ditambah','success'); initMenu();
        }

        async function hapusMenu(id) { if(confirm("Hapus?")) { await client.from('menu').delete().eq('id', id); initMenu(); } }
        async function toggleStok(id, stat) { await client.from('menu').update({tersedia:!stat}).eq('id', id); initMenu(); }

        initLaporan();
    </script>
</body>
</html>
